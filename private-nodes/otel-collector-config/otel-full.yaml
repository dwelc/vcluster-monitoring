---
mode: daemonset
presets:
  kubeletMetrics:
    enabled: true
  kubernetesAttributes:
    enabled: true
service:
  enabled: true
clusterRole:
  rules:
  - apiGroups: [""]
    resources: ["nodes", "nodes/metrics", "nodes/proxy", "services", "endpoints", "pods", "namespaces"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["replicasets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions"]
    resources: ["replicasets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["nodes/stats"]
    verbs: ["get", "list", "watch"]
  - nonResourceURLs: ["/metrics", "/metrics/cadvisor"]
    verbs: ["get"]
config:
  receivers:
    kubeletstats:
      insecure_skip_verify: true
    prometheus:
      config:
        scrape_configs:
          - job_name: 'kubelet'
            scrape_interval: 30s
            kubernetes_sd_configs:
              - role: node
            scheme: https
            tls_config:
              insecure_skip_verify: true
            authorization:
              credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            relabel_configs:
              # Only scrape the node this pod is running on
              - source_labels: [__meta_kubernetes_node_name]
                regex: ${env:K8S_NODE_NAME}
                action: keep
              - source_labels: [__meta_kubernetes_node_address_InternalIP]
                target_label: __address__
                replacement: '$$1:10250'
              - action: labelmap
                regex: __meta_kubernetes_node_label_(.+)
              - source_labels: [__meta_kubernetes_node_name]
                target_label: node

          - job_name: 'kubelet-cadvisor'
            scrape_interval: 30s
            kubernetes_sd_configs:
              - role: node
            scheme: https
            tls_config:
              insecure_skip_verify: true
            authorization:
              credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            metrics_path: /metrics/cadvisor
            relabel_configs:
              # Only scrape the node this pod is running on
              - source_labels: [__meta_kubernetes_node_name]
                regex: ${env:K8S_NODE_NAME}
                action: keep
              - source_labels: [__meta_kubernetes_node_address_InternalIP]
                target_label: __address__
                replacement: '$$1:10250'
              - action: labelmap
                regex: __meta_kubernetes_node_label_(.+)
              - source_labels: [__meta_kubernetes_node_name]
                target_label: node

          - job_name: 'apiserver'
            scrape_interval: 30s
            kubernetes_sd_configs:
              - role: endpoints
                namespaces:
                  names: ['default']
            scheme: https
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              insecure_skip_verify: false
            authorization:
              credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            relabel_configs:
              - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
                action: keep
                regex: kubernetes;https
  processors:
    attributes:
      actions:
      - action: upsert
        key: cluster
        value: "{{ .Values.loft.cluster }}"
      - action: upsert
        key: loft_project_name
        value: "{{ .Values.loft.project }}"
      - action: upsert
        key: loft_virtualcluster_name
        value: "{{ .Values.loft.name }}"
      - action: upsert
        key: loft_user_name
        value: "{{ .Values.loft.user.name }}"
    k8sattributes:
      auth_type: 'serviceAccount'
      extract:
        metadata:
        - k8s.namespace.name
        - k8s.pod.name
        - k8s.pod.start_time
        - k8s.pod.uid
        - k8s.deployment.name
        - k8s.node.name
    transform:
      error_mode: ignore
      metric_statements:
        context: datapoint
        statements:
        - 'set(attributes["k8s.node.name"], resource.attributes["k8s.node.name"])'
        - 'set(attributes["k8s.pod.name"], resource.attributes["k8s.pod.name"])'
        - 'set(attributes["k8s.namespace.name"], resource.attributes["k8s.namespace.name"])'
    memory_limiter:
      check_interval: 1s
      limit_percentage: 75
      spike_limit_percentage: 15
    batch:
      send_batch_size: 10000
      timeout: 10s
  exporters:
    otlphttp/prometheus:
      endpoint: '{{ .Values.prometheus.endpoint }}/api/v1/otlp'
      tls:
        insecure_skip_verify: {{ .Values.prometheus.insecure }}
  service:
    extensions:
    - health_check
    pipelines:
      metrics:
        receivers:
        - kubeletstats
        - prometheus
        processors:
        - batch
        - memory_limiter
        - k8sattributes
        - attributes
        - transform
        exporters:
        - otlphttp/prometheus
